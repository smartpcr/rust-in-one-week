name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and test on Linux (for cross-platform modules)
  build-linux:
    name: Build & Test (Linux)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build all modules
        run: cargo build --workspace --verbose

      - name: Run tests (excluding Windows-only)
        run: cargo test --workspace --verbose

  # Build and test on Windows (for Windows-specific modules)
  build-windows:
    name: Build & Test (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.82.0
          targets: x86_64-pc-windows-msvc

      - name: Setup MSVC Developer Environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build all modules
        run: cargo build --workspace --verbose

      - name: Run tests (excluding cluster tests)
        run: cargo test --workspace --verbose

  # Windows Server with Failover Cluster and Hyper-V for integration tests
  build-windows-server:
    name: Build & Test (Windows Server + Hyper-V + Cluster)
    runs-on: [hub-win-2025]
    # Requires a self-hosted runner with:
    # - Windows Server 2019/2022/2025
    # - Hyper-V role installed
    # - Failover Clustering feature installed
    # - Runner configured with admin privileges
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Debug Runner Info
        shell: cmd
        run: |
          echo "Runner Name: %RUNNER_NAME%"
          echo "Computer Name: %COMPUTERNAME%"
          hostname
          echo "Checking for pwsh..."
          where pwsh || echo "pwsh not found in PATH"
          echo "Checking for powershell..."
          where powershell
          echo "PATH: %PATH%"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure PowerShell Core is installed
        shell: powershell
        run: |
          if (!(Get-Command pwsh -ErrorAction SilentlyContinue)) {
            Write-Host "Installing PowerShell Core..."
            $url = "https://github.com/PowerShell/PowerShell/releases/download/v7.4.6/PowerShell-7.4.6-win-x64.msi"
            $msiPath = "$env:TEMP\PowerShell.msi"
            Invoke-WebRequest -Uri $url -OutFile $msiPath
            Start-Process msiexec.exe -ArgumentList "/i", $msiPath, "/quiet", "/norestart", "ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1", "ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1", "ENABLE_PSREMOTING=1", "REGISTER_MANIFEST=1", "USE_MU=1", "ENABLE_MU=1", "ADD_PATH=1" -Wait
            Remove-Item $msiPath
            # Refresh PATH
            $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
            Write-Host "PowerShell Core installed successfully"
          } else {
            Write-Host "PowerShell Core already installed"
            pwsh --version
          }

      - name: Install Rust toolchain
        shell: pwsh
        run: |
          # Check if rustup is installed, if not install it
          if (!(Get-Command rustup -ErrorAction SilentlyContinue)) {
            Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
            ./rustup-init.exe -y --default-toolchain 1.82.0 --default-host x86_64-pc-windows-msvc
            Remove-Item rustup-init.exe
          }
          # Add cargo to PATH for this session
          $env:Path = "$env:USERPROFILE\.cargo\bin;$env:Path"
          # Install/update to specified toolchain
          rustup toolchain install 1.82.0
          rustup default 1.82.0
          rustup target add x86_64-pc-windows-msvc
          # Verify installation
          rustc --version
          cargo --version

      - name: Add Cargo to PATH
        shell: pwsh
        run: echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH

      - name: Setup MSVC Developer Environment
        uses: ilammy/msvc-dev-cmd@v1

      - name: Verify Windows Server features
        shell: pwsh
        run: .github/scripts/verify-windows-features.ps1

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-server-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-server-

      - name: Build workspace
        run: cargo build --workspace --verbose

      - name: Run unit tests
        run: cargo test --workspace --verbose

      - name: Run hv integration tests (Hyper-V required)
        run: cargo test -p hv --verbose -- --ignored
        continue-on-error: true

      - name: Run clus integration tests (cluster required)
        run: cargo test -p clus --verbose -- --ignored
        continue-on-error: true

      - name: Run api integration tests
        run: cargo test -p api --verbose -- --ignored
        continue-on-error: true

  # Lint and format check
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt,clippy
          toolchain: 1.82.0

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run Clippy
        run: cargo clippy --workspace -- -D warnings
        continue-on-error: true  # Don't fail on clippy warnings for now
